<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Influencer Reputation</title>

  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --shadow: 0 10px 25px rgba(2,6,23,.08); --radius: 16px;
      --blue:#2563eb;

      /* AMBEV yellow */
      --ambev-yellow:#FFC600;
      --ambev-yellow-hover:#FFB800;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1180px;margin:22px auto 60px;padding:0 16px}

    /* ---------- Top selector bar ---------- */
    .topBar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .picker{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="search"], select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      background:#fff;
      font-weight:900;
      color:var(--text);
      outline:none;
      min-width:220px;
      flex:1;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      background:var(--ambev-yellow) !important;
      color:#0f172a !important;
      border-color:var(--ambev-yellow) !important;
    }
    .btn.primary:hover{
      background:var(--ambev-yellow-hover) !important;
      border-color:var(--ambev-yellow-hover) !important;
    }
    .btn.primary:active{ transform: translateY(1px); }

    /* ---------- Empty state ---------- */
    .empty{
      margin-top:16px;
      background:var(--card);
      border:1px dashed var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
    }
    .emptyTitle{margin:0 0 6px;font-size:18px;font-weight:1000}
    .emptyText{margin:0;color:var(--muted);font-weight:800;line-height:1.4}

    /* ---------- Main view ---------- */
    .header{
      margin-top:16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .left{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
      min-width:260px;
      flex:1;
    }
    .avatar{
      width:60px;height:60px;border-radius:999px;border:1px solid var(--line);
      background:linear-gradient(135deg,#c7d2fe,#e0e7ff);
      overflow:hidden;display:grid;place-items:center;font-weight:1000;color:#1e293b;
      cursor:pointer;
      flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .title{margin:0;font-size:20px;font-weight:1000;line-height:1.1}
    .subRow{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    a{color:var(--blue);text-decoration:none;font-weight:1000}
    a:hover{text-decoration:underline}
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      font-size:11px;
      background:#f8fafc;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    /* Score meter */
    .scoreCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      min-width:240px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .scoreTop{display:flex;justify-content:space-between;align-items:flex-end;gap:10px}
    .scoreLabel{color:var(--muted);font-weight:1000;font-size:12px}
    .scoreValue{font-weight:1000;font-size:22px;line-height:1}
    .meter{
      width:100%;
      height:14px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .meterFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #16a34a 0%, #f59e0b 55%, #ef4444 100%);
      transition: width .2s ease;
    }
    .meterTicks{display:flex;justify-content:space-between;color:var(--muted);font-weight:900;font-size:11px}

    /* Cards */
    .grid{margin-top:16px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .cardTitle{margin:0;font-weight:1000;font-size:15px}
    .muted{color:var(--muted);font-weight:750;font-size:13px;line-height:1.45}

    /* Flags + deep dive */
    .flagsWrap{display:grid;grid-template-columns: 1.1fr .9fr;gap:14px}
    @media (max-width: 920px){ .flagsWrap{grid-template-columns:1fr} }
    .flagsList{display:flex;flex-wrap:wrap;gap:8px}
    .flagChip{
      border:1px solid var(--line);
      background:#f8fafc;
      border-radius:999px;
      padding:7px 10px;
      font-weight:1000;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .flagChip.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .flagChip .count{
      background:#fff;border:1px solid var(--line);
      padding:3px 7px;border-radius:999px;font-size:11px;color:var(--muted)
    }
    .flagChip.active .count{color:#0f172a}
    .deepDive{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      min-height:120px;
    }
    .deepDiveTitle{font-weight:1000;margin:0 0 10px;font-size:13px}
    .wordsGrid{display:flex;flex-wrap:wrap;gap:8px}
    .wordPill{
      font-size:12px;font-weight:1000;
      padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;
    }

    /* Flag hits bar (0..33) */
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .kpiTop{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap}
    .kpiTop .big{font-size:26px;font-weight:1000;line-height:1}
    .kpiTop .small{font-size:12px;color:var(--muted);font-weight:900;text-align:right}
    .bar{width:100%;height:12px;border-radius:999px;background:#f1f5f9;border:1px solid var(--line);overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ef4444,#f59e0b);transition:width .2s ease}
    .barLegend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;font-weight:900}

    /* Summary Markdown */
    .summaryMarkdown{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:14px;
    }
    .summaryMarkdown h2{
      margin:0 0 10px;
      font-size:15px;
      font-weight:1000;
    }
    .summaryMarkdown p{
      margin:10px 0;
      font-size:13px;
      line-height:1.6;
      font-weight:400; /* body NOT bold */
      color:var(--text);
      white-space:normal;
    }
    .summaryMarkdown strong{
      font-weight:1000; /* ONLY bold */
    }

    /* Evidence */
    .filters{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .filterGroup{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .boxes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width: 980px){.boxes{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 620px){.boxes{grid-template-columns:1fr}}

    .box{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden;display:flex;flex-direction:column;min-height:220px}
    .boxImg{height:130px;background:linear-gradient(135deg,#e2e8f0,#f1f5f9)}
    .boxImg img{width:100%;height:100%;object-fit:cover}
    .boxBody{padding:12px;display:flex;flex-direction:column;gap:10px;flex:1}
    .boxTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .date{color:var(--muted);font-weight:900;font-size:11px}
    .titleLink{font-weight:1000;color:var(--blue);text-decoration:none;line-height:1.25;font-size:13px}
    .titleLink:hover{text-decoration:underline}
    .snippet{color:var(--text);font-weight:750;font-size:13px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;min-height:60px}
    .tagRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:auto}
    .miniTag{font-size:11px;font-weight:1000;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--text)}

    .pagination{margin-top:14px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap}
    .pageBtn{border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:10px;font-weight:1000;cursor:pointer;min-width:38px;text-align:center}
    .pageBtn.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .pageInfo{color:var(--muted);font-weight:900;font-size:12px;margin-top:10px;text-align:center}
  </style>
</head>

<body>
  <div class="container">

    <section class="topBar">
      <div class="picker">
        <input id="search" type="search" placeholder="Search by name or Instagram (e.g., Bad Bunny / @badbunnypr)"/>
        <select id="select">
          <option value="">Select an influencer…</option>
        </select>
        <button class="btn primary" id="openBtn">Open</button>
      </div>

      <!-- MARKUP ONLY: add new influencers in INFLUENCERS + OUTPUTS -->
    </section>

    <section class="empty" id="emptyState">
      <h2 class="emptyTitle">Select an influencer</h2>
      <p class="emptyText">
        Use the search box or the dropdown above. Once selected, the reputation view will appear here.
      </p>
    </section>

    <div id="mainView" style="display:none">
      <section class="header">
        <div class="left">
          <!-- Instagram link works on GitHub Pages -->
          <a id="igHeaderLink" href="#" target="_blank" rel="noreferrer"
             style="display:flex;gap:14px;align-items:center;color:inherit;text-decoration:none">
            <div class="avatar">
              <img id="avatarImg" alt="avatar" src="" style="display:none"/>
              <span id="avatarFallback">IN</span>
            </div>
            <div>
              <h1 class="title" id="infName">—</h1>
              <div class="subRow">
                <span class="pill" id="igHandlePill">@—</span>
              </div>
            </div>
          </a>
        </div>

        <div class="scoreCard">
          <div class="scoreTop">
            <div>
              <div class="scoreLabel">Score (0–100)</div>
              <div class="scoreValue" id="scoreValue">0</div>
            </div>
          </div>
          <div class="meter"><div class="meterFill" id="meterFill"></div></div>
          <div class="meterTicks"><span>0</span><span>50</span><span>100</span></div>
        </div>
      </section>

      <div class="grid">

        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Flags (tags) + Deep dive (keywords)</h3>
          </div>

          <div class="flagsWrap">
            <div>
              <div class="flagsList" id="flagsList"></div>
              <div class="muted" style="margin-top:10px">
                Click a flag to see the detected keywords.
              </div>
            </div>

            <div class="deepDive">
              <p class="deepDiveTitle" id="deepDiveTitle">Detected keywords</p>
              <div class="wordsGrid" id="wordsGrid"></div>
              <div class="muted" id="deepDiveHint" style="margin-top:10px;display:none">
                No keywords for this flag.
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Flag hits (0–33)</h3>
          </div>

          <div class="kpi">
            <div class="kpiTop">
              <div>
                <div style="font-weight:1000;font-size:13px">Total flags hit</div>
                <div class="big" id="flagHitsTotal">0</div>
              </div>
              <div class="small">
                Max: <span id="flagHitsMax">33</span><br/>
                % bar: <span id="flagHitsPct">0%</span>
              </div>
            </div>

            <div class="bar"><span id="flagHitsBar"></span></div>
            <div class="barLegend">
              <span>0</span><span>33</span>
            </div>

            <div class="muted">
              Total flags hit = number of <b>unique tags</b> detected for this influencer.
            </div>
          </div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Influencer Legal & Brand Risk Assessment</h3>
          </div>

          <!-- Summary rendered as Markdown -->
          <div class="summaryMarkdown" id="summaryMarkdown"></div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Evidence (Web / News)</h3>
          </div>

          <div class="filters">
            <div class="filterGroup">
              <select id="flagFilter"></select>
              <select id="sortFilter">
                <option value="recent">Sort: Most recent</option>
                <option value="quantity">Sort: Quantity (keywords per tag)</option>
              </select>
            </div>
          </div>

          <div class="boxes" id="boxes"></div>
          <div class="pagination" id="pagination"></div>
          <div class="pageInfo" id="pageInfo"></div>

          <div class="muted" style="margin-top:12px">
            News cards attempt to load a website preview image via a public service (best effort).
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // DATA
    // ============================================================================
    const INFLUENCERS = [
      { influencer_id: "bad_bunny", name: "Bad Bunny", instagram_handle: "badbunnypr" },
      { influencer_id: "ewan_mcgregor", name: "Ewan McGregor", instagram_handle: "officialewanmcgregor_" },
      { influencer_id: "vincent_cassel", name: "Vincent Cassel", instagram_handle: "vincentcassel" },
      { influencer_id: "taylor_fritz",  name: "Taylor Fritz",  instagram_handle: "taylor_fritz" }
    ];

    // NOTE: summary_text is now Markdown (supports # and **bold**)
    const OUTPUTS = {
      bad_bunny: {
        score_0_100: 85,
        flag_counting_rows: [
          { influencer: "Bad Bunny", tag: "sensitive political topics", words: "super|bowl|halftime|probe|congress|fcc|backlash|trump|maga|immigration|spanish|lyrics" }
        ],
        evidence_links_rows: [
          { influencer: "Bad Bunny", tag: "sensitive political topics", url: "https://www.axios.com/2026/02/10/bad-bunny-super-bowl-halftime-show-fcc-investigation" },
          { influencer: "Bad Bunny", tag: "sensitive political topics", url: "https://www.nytimes.com/2026/02/09/us/trump-bad-bunny-super-bowl-halftime-show.html" },
          { influencer: "Bad Bunny", tag: "sensitive political topics", url: "https://www.theguardian.com/us-news/2026/feb/08/bad-bunny-super-bowl-trump-maga" },
          { influencer: "Bad Bunny", tag: "sensitive political topics", url: "https://www.bbc.com/news/articles/cd0y18g8g7ro" }
        ],
        summary_text: `# Influencer Legal & Brand Risk Assessment
**1. Profile Context**  
Bad Bunny is a globally recognized Latin music artist with high relevance for campaigns targeting diverse and youth-oriented audiences. This assessment is prompted by recent high-profile controversy linked to his Super Bowl halftime performance and ongoing public discourse regarding his cultural and political advocacy.
**2. Positive Partnership Signals**  
Bad Bunny maintains significant credibility and cultural influence, with a history of professional engagement and strong alignment to causes resonant with multicultural and progressive demographics. His visibility and advocacy may enhance brand relevance in markets prioritizing diversity and inclusion.
**3. Legal, Regulatory & Reputational Exposure**  
Bad Bunny’s association with explicit content, overt political symbolism, commentary on sensitive immigration and cultural topics, and public critiques from right-wing political figures suggest potential for regulatory scrutiny and reputational exposure. Prior congressional inquiries and calls for FCC investigation may indicate an elevated likelihood of public or political backlash, especially among conservative stakeholders.
**4. Net Partnership Exposure Assessment**  
Overall, the partnership presents a moderate-to-elevated exposure profile due to recent high-visibility controversies. However, credible brand alignment and audience engagement potential remain strong for organizations comfortable with cultural advocacy. The risk profile is increased in contexts with heightened sensitivity to political and social issues.
**5. Legal Positioning Recommendation**  
Suitable with safeguards / monitoring. Partnership should include enhanced compliance review, content alignment protocols, and ongoing monitoring for emerging risks. Escalation advised if campaign objectives intersect with sensitive policy or regulatory domains.`
      },

      ewan_mcgregor: {
        score_0_100: 0,62,
        flag_counting_rows: [
          { influencer: "Ewan McGregor", tag: "Sensitive Political Topics", words: "snub|interview|piers|morgan|womens|march|row|boris|johnson|brexit|tweets|tirade" }
        ],
        evidence_links_rows: [
          { influencer: "Ewan McGregor", tag: "Sensitive Political Topics", url: "https://www.theguardian.com/film/2017/jan/24/ewan-mcgregor-snubs-good-morning-britain-interview-piers-morgan-womens-march-row" },
          { influencer: "Ewan McGregor", tag: "Sensitive Political Topics", url: "https://www.usatoday.com/story/news/nation-now/2016/06/30/ewan-mcgregor-foul-mouthed-tirade-boris-johnson-brexit/86554272/" }
        ],
        summary_text: `# Influencer Legal & Brand Risk Assessment
**1. Profile Context**  
Ewan McGregor is a high-profile actor known for roles in globally recognized productions and ongoing media visibility. His relevance for partnership consideration is high due to significant public reach; recent media coverage has prompted an assessment in relation to sensitive topics and public conduct.
**2. Positive Partnership Signals**  
McGregor demonstrates credible professional standing, industry recognition, and alignment with public health initiatives, including active promotion of COVID-19 relief efforts. His participation in reputable philanthropic campaigns and general media engagement may indicate positive transparency and social responsibility.
**3. Legal, Regulatory & Reputational Exposure**  
Analysis suggests potential exposure related to McGregor’s public commentary on political figures and UK political campaigns, as well as past association with publicly reported personal relationship controversies. His involvement with politically sensitive content and cross-platform entertainment competitors also presents possible brand, regulatory, and reputational considerations.
**4. Net Partnership Exposure Assessment**  
While McGregor’s public profile and prior news associations may suggest moderate exposure to brand and reputational risk, notable positive indicators and ongoing professional engagements point to an overall manageable risk profile. Timely monitoring of emerging controversies and public narratives is advisable to maintain defensibility of partnership.
**5. Legal Positioning Recommendation**  
Suitable with safeguards / monitoring`
      },

      vincent_cassel: {
        score_0_100: 30,
        flag_counting_rows: [
          { influencer: "Vincent Cassel", tag: "brand endorsement", words: "fashion|moncler|show|brand|campaign|style|cinema|influences|modeling|event|exclusive|dialogue" }
        ],
        evidence_links_rows: [
          { influencer: "Vincent Cassel", tag: "brand endorsement", url: "https://infobae.com/entretenimiento/2025/03/20/vincent-cassel-sobre-su-influencias-en-el-cine-y-la-moda-es-cuestion-de-dejarse-llevar" }
        ],
        summary_text: `**1. Profile Context**  
Vincent Cassel is a public figure with an established career in entertainment and modeling, recently associated with Moncler via participation in an exclusive fashion event. This assessment is triggered by direct brand collaboration and endorsement activity.

**2. Positive Partnership Signals**  
Cassel’s engagement with Moncler demonstrates alignment between his personal brand and the company’s image, suggesting credibility and professional conduct within public-facing collaborations. No indicators of opaque or misleading representation were identified in this context.

**3. Legal, Regulatory & Reputational Exposure**  
Current evidence does not reference past controversies or misconduct relating to Cassel or his Moncler collaboration. The partnership context is limited to fashion endorsement, which may indicate minimal regulatory or reputational exposure unless further information emerges.

**4. Net Partnership Exposure Assessment**  
Available information supports a low exposure profile from both legal and reputational perspectives, with positive signals outweighing risk indicators. The potential for adverse impact appears limited based on the scope of existing collaboration.

**5. Legal Positioning Recommendation**  
Suitable for partnership. Continued monitoring is advisable to ensure ongoing alignment with legal, compliance, and brand safety standards.`
      },

      taylor_fritz: {
        score_0_100: 12,
        flag_counting_rows: [
          { influencer: "Taylor Fritz", tag: "Negative Sentiment",       words: "trolls|abuse|comments|backlash|social|media|australian|open|criticize|defend|clap|respond" },
          { influencer: "Taylor Fritz", tag: "Collaboration Experience", words: "collaboration|brand|lifestyle|partnership|campaign|fashion|gen|crew|tennis|dc|open" },
          { influencer: "Taylor Fritz", tag: "Protest",                  words: "climate|protest|match|delay|washington|guardian|crowd|hold|off" },
          { influencer: "Taylor Fritz", tag: "Abuse",                    words: "harassment|online|abuse|trolls|backlash|comments|posts" }
        ],
        evidence_links_rows: [
          { influencer: "Taylor Fritz", tag: "Negative Sentiment", url: "https://www.dailymail.co.uk/sport/tennis/article-14494687/Tennis-WAG-Morgan-Riddle-boyfriend-Taylor-Fritz-trolls.html" },
          { influencer: "Taylor Fritz", tag: "Collaboration Experience", url: "https://www.si.com/onsi/serve/interviews/taylor-fritz-beach-inspired-tennis-collaboration-dc-open" },
          { influencer: "Taylor Fritz", tag: "Protest", url: "https://www.theguardian.com/sport/2023/aug/05/taylor-fritz-andy-murray-citi-open-climate-protest-tennis" }
        ],
        summary_text: `# Influencer Legal & Brand Risk Assessment

**1. Profile Context**  
Taylor Fritz is a professional tennis player considered for brand partnership following recent public engagement, increased media visibility, and collaborative activity, prompting a risk and legal exposure assessment.

**2. Positive Partnership Signals**  
Fritz demonstrates collaboration experience through a recent partnership with a recognized lifestyle brand, indicating commercial viability and professional conduct. His affiliations suggest established credibility and positive brand association within the sports and entertainment sector.

**3. Legal, Regulatory & Reputational Exposure**  
Exposure indicators include negative social media discourse targeting an associate (Fritz's girlfriend), public commentary on sensitive issues such as domestic violence (involving other parties), and association with events subject to protest activity. These elements may contribute to perceived reputational vulnerability and audience sentiment volatility, though direct involvement in policy violations or misconduct by Fritz himself is not evident.

**4. Net Partnership Exposure Assessment**  
Overall exposure level may be considered moderate, characterized primarily by indirect association with contentious topics rather than substantiated personal misconduct. Risk factors are subject to heightened media attention but may be mitigated through monitoring and responsive communications protocols.

**5. Legal Positioning Recommendation**  
Suitable with safeguards / monitoring`
      }
    };

    // ============================================================================
    // DOM + STATE
    // ============================================================================
    const $ = (id) => document.getElementById(id);

    let selectedInfluencerId = "";
    let activeTag = null;
    let currentPage = 1;
    const pageSize = 6;

    // ============================================================================
    // Helpers (safe HTML + tag encoding)
    // ============================================================================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // IMPORTANT: encode tags for attributes (fixes GitHub Pages weirdness)
    function tagKey(tag){ return encodeURIComponent(String(tag ?? "")); }
    function tagFromKey(key){ return decodeURIComponent(String(key ?? "")); }

    function safeUrl(url){
      return encodeURI(String(url ?? "").trim());
    }

    function instagramUrl(handle){
      return handle ? `https://www.instagram.com/${encodeURIComponent(handle)}/` : "#";
    }
    function instagramAvatarUrl(handle){
      return handle ? `https://unavatar.io/instagram/${encodeURIComponent(handle)}` : "";
    }

    function renderScore(score){
      const s = Math.max(0, Math.min(100, Number(score) || 0));
      $("scoreValue").textContent = String(s);
      $("meterFill").style.width = s + "%";
    }

    function buildTagKeywordsMap(rows){
      const map = new Map();
      (rows || []).forEach(r => {
        const tag = (r.tag || "").trim();
        const parts = String(r.words || "")
          .split("|")
          .map(w => w.trim())
          .filter(Boolean);

        if(!map.has(tag)) map.set(tag, new Set());
        const set = map.get(tag);
        parts.forEach(p => set.add(p));
      });
      return map;
    }

    function buildTagCounts(tagKeywordsMap){
      const counts = [];
      for(const [tag, set] of tagKeywordsMap.entries()){
        counts.push({ tag, count: set.size });
      }
      counts.sort((a,b) => b.count - a.count);
      return counts;
    }

    function computeFlagHits(tagCounts){
      return Math.min(33, (tagCounts || []).length);
    }

    function normalizeEvidence(rows){
      const seen = new Set();
      const out = [];
      (rows || []).forEach(r => {
        const tag = (r.tag || "").trim();
        const url = (r.url || "").trim();
        if(!tag || !url) return;

        const key = tag + "||" + url;
        if(seen.has(key)) return;
        seen.add(key);

        const previewImg = `https://image.thum.io/get/width/900/${encodeURIComponent(url)}`;

        out.push({
          evidence_id: "ev_" + String(out.length + 1).padStart(3,"0"),
          tag,
          url,
          title: url,
          snippet: "",
          publication_date: "",
          image_url: previewImg
        });
      });
      return out;
    }

    function renderDeepDive(tag, tagKeywordsMap){
      const set = tagKeywordsMap.get(tag) || new Set();
      $("deepDiveTitle").textContent = `Detected keywords — ${tag}`;
      $("wordsGrid").innerHTML = Array.from(set)
        .sort((a,b)=>a.localeCompare(b))
        .map(w => `<span class="wordPill">${escapeHtml(w)}</span>`)
        .join("");
      $("deepDiveHint").style.display = set.size ? "none" : "block";
    }

    // ============================================================================
    // Markdown renderer (minimal, safe)
    // Supports:
    //   # Title
    //   **Bold**
    //   Two spaces + newline line breaks
    // ============================================================================
    function renderMarkdownSafe(md){
      const raw = String(md || "").trim();
      if(!raw) return "<p>—</p>";

      // Escape HTML first, then allow **bold** and headings
      let txt = escapeHtml(raw);

      // Convert Windows newlines
      txt = txt.replaceAll("\r\n", "\n");

      // Heading: "# ..."
      // We'll transform line-by-line
      const lines = txt.split("\n");
      const html = [];
      for(let i=0;i<lines.length;i++){
        let line = lines[i];

        // Markdown heading
        if(line.startsWith("# ")){
          const title = line.slice(2).trim();
          html.push(`<h2>${title}</h2>`);
          continue;
        }

        // Empty line => paragraph break
        if(line.trim() === ""){
          html.push("");
          continue;
        }

        // Bold: **...**
        line = line.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

        // Markdown hard-break "  " at end is already in your text; we just treat every newline as <br> inside paragraph blocks
        html.push(`<p>${line}</p>`);
      }

      // Merge consecutive <p> into a single flow is not required; keep simple.
      return html.filter(Boolean).join("");
    }

    // Evidence: filter + sort + pagination
    function getFilteredEvidence(evidence){
      const rawVal = $("flagFilter").value;
      const selectedTag = (rawVal === "all") ? "all" : tagFromKey(rawVal);
      const sort = $("sortFilter").value;

      let list = [...evidence];
      if(selectedTag !== "all") list = list.filter(ev => ev.tag === selectedTag);

      if(sort === "quantity"){
        list.sort((a,b) => (b._tag_keyword_count||0) - (a._tag_keyword_count||0));
      }else{
        list.sort((a,b) => (b.publication_date||"").localeCompare(a.publication_date||""));
      }
      return list;
    }

    function buildPagination(totalPages){
      const btns = [];
      btns.push(`<div class="pageBtn" data-page="${Math.max(1, currentPage-1)}">«</div>`);

      const maxButtons = 7;
      let from = Math.max(1, currentPage - 2);
      let to = Math.min(totalPages, from + (maxButtons - 1));
      from = Math.max(1, to - (maxButtons - 1));

      for(let p=from;p<=to;p++){
        btns.push(`<div class="pageBtn ${p===currentPage?'active':''}" data-page="${p}">${p}</div>`);
      }
      btns.push(`<div class="pageBtn" data-page="${Math.min(totalPages, currentPage+1)}">»</div>`);
      return btns.join("");
    }

    function bindPaginationClicks(){
      document.querySelectorAll("#pagination .pageBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const p = Number(btn.getAttribute("data-page") || "1");
          currentPage = p;
          renderMain();
          const el = document.querySelector(".filters");
          if(el){
            window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 140, behavior:"smooth" });
          }
        });
      });
    }

    function renderEvidence(evidence){
      const list = getFilteredEvidence(evidence);
      const total = list.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage - 1) * pageSize;
      const slice = list.slice(start, start + pageSize);

      $("boxes").innerHTML = slice.map(ev => {
        const imgHtml = ev.image_url
          ? `<div class="boxImg">
               <img alt="preview" src="${escapeHtml(ev.image_url)}"
                    onerror="this.remove(); this.parentElement.style.display='none'">
             </div>`
          : ``;

        return `
          <div class="box">
            ${imgHtml}
            <div class="boxBody">
              <div class="boxTop">
                <span class="pill">WEB/NEWS</span>
                <span class="date">${escapeHtml(ev.publication_date || "")}</span>
              </div>
              <a class="titleLink" href="${safeUrl(ev.url)}" target="_blank" rel="noreferrer">
                ${escapeHtml(ev.title || ev.url)}
              </a>
              <div class="snippet">${escapeHtml(ev.snippet || "")}</div>
              <div class="tagRow">
                <span class="miniTag">tag: ${escapeHtml(ev.tag)}</span>
                <span class="miniTag">keywords: ${escapeHtml(ev._tag_keyword_count || 0)}</span>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">No evidence for this filter.</div>`;

      $("pagination").innerHTML = buildPagination(totalPages);
      bindPaginationClicks();

      const showingFrom = total === 0 ? 0 : start + 1;
      const showingTo = Math.min(total, start + slice.length);
      $("pageInfo").textContent = `${showingFrom} - ${showingTo} of ${total} (page ${currentPage}/${totalPages})`;
    }

    // ============================================================================
    // Main render after selection
    // ============================================================================
    function renderMain(){
      if(!selectedInfluencerId){
        $("mainView").style.display = "none";
        $("emptyState").style.display = "block";
        return;
      }

      const inf = INFLUENCERS.find(x => x.influencer_id === selectedInfluencerId);
      const out = OUTPUTS[selectedInfluencerId];

      $("emptyState").style.display = "none";
      $("mainView").style.display = "block";

      // Instagram link (header)
      const ig = instagramUrl(inf.instagram_handle);
      $("igHeaderLink").href = ig;
      $("igHandlePill").textContent = inf.instagram_handle ? `@${inf.instagram_handle}` : "—";

      $("infName").textContent = inf?.name || "—";
      $("avatarFallback").textContent = (inf?.name || "IN")
        .split(" ").slice(0,2).map(x=>x[0]).join("").toUpperCase();

      const img = $("avatarImg");
      img.src = instagramAvatarUrl(inf.instagram_handle);
      if(inf.instagram_handle){
        img.onload = () => { img.style.display="block"; $("avatarFallback").style.display="none"; };
        img.onerror = () => { img.style.display="none"; $("avatarFallback").style.display="block"; };
      }else{
        img.style.display="none"; $("avatarFallback").style.display="block";
      }

      renderScore(out?.score_0_100 ?? 0);

      // Tags/keywords
      const tagKeywordsMap = buildTagKeywordsMap(out?.flag_counting_rows || []);
      const tagCounts = buildTagCounts(tagKeywordsMap);

      if(!activeTag){
        activeTag = tagCounts[0]?.tag || null;
      }

      // Flags list (IMPORTANT: use encoded tag in data-tag)
      $("flagsList").innerHTML = tagCounts.map(x => `
        <span class="flagChip ${x.tag===activeTag?'active':''}" data-tag="${tagKey(x.tag)}">
          ${escapeHtml(x.tag)}
          <span class="count">${escapeHtml(x.count)}</span>
        </span>
      `).join("") || `<span class="muted">No flags.</span>`;

      // Bind flag clicks (deep dive)
      document.querySelectorAll(".flagChip").forEach(el => {
        el.addEventListener("click", () => {
          activeTag = tagFromKey(el.getAttribute("data-tag"));
          renderDeepDive(activeTag, tagKeywordsMap);
          document.querySelectorAll(".flagChip").forEach(ch => ch.classList.remove("active"));
          el.classList.add("active");
        });
      });

      if(activeTag) renderDeepDive(activeTag, tagKeywordsMap);

      // Flag hits
      const hits = computeFlagHits(tagCounts);
      const pct = Math.round((hits / 33) * 100);
      $("flagHitsTotal").textContent = String(hits);
      $("flagHitsMax").textContent = "33";
      $("flagHitsPct").textContent = pct + "%";
      $("flagHitsBar").style.width = pct + "%";

      // Summary markdown
      $("summaryMarkdown").innerHTML = renderMarkdownSafe(out?.summary_text || "");

      // Evidence
      const evidence = normalizeEvidence(out?.evidence_links_rows || []);
      evidence.forEach(ev => {
        const set = tagKeywordsMap.get(ev.tag) || new Set();
        ev._tag_keyword_count = set.size;
      });

      // Build filter options (encoded values)
      const tags = tagCounts.map(x => x.tag);
      const currentFilter = $("flagFilter").value || "all";

      $("flagFilter").innerHTML =
        `<option value="all">Filter by Flag (tag)</option>` +
        tags.map(tg => `<option value="${tagKey(tg)}">${escapeHtml(tg)}</option>`).join("");

      // Keep selection if still exists
      const decodedCurrent = (currentFilter === "all") ? "all" : tagFromKey(currentFilter);
      if(decodedCurrent !== "all" && tags.includes(decodedCurrent)){
        $("flagFilter").value = tagKey(decodedCurrent);
      }else{
        $("flagFilter").value = "all";
      }

      renderEvidence(evidence);
    }

    // ============================================================================
    // Selector behavior
    // ============================================================================
    function populateSelect(options){
      $("select").innerHTML =
        `<option value="">Select an influencer…</option>` +
        options.map(i => `<option value="${escapeHtml(i.influencer_id)}">${escapeHtml(i.name)} (@${escapeHtml(i.instagram_handle||'')})</option>`).join("");
    }

    function applySearch(){
      const q = $("search").value.trim().toLowerCase();
      const filtered = INFLUENCERS.filter(i =>
        !q ||
        i.name.toLowerCase().includes(q) ||
        (i.instagram_handle||"").toLowerCase().includes(q) ||
        ("@" + (i.instagram_handle||"")).toLowerCase().includes(q)
      );
      populateSelect(filtered);
    }

    $("search").addEventListener("input", () => {
      const current = $("select").value;
      applySearch();
      $("select").value = current;
    });

    function openSelected(){
      selectedInfluencerId = $("select").value || "";
      activeTag = null;
      currentPage = 1;
      renderMain();
    }

    $("openBtn").addEventListener("click", () => {
      if(!$("select").value){
        selectedInfluencerId = "";
        renderMain();
        return;
      }
      openSelected();
    });

    $("flagFilter").addEventListener("change", () => { currentPage = 1; renderMain(); });
    $("sortFilter").addEventListener("change", () => { currentPage = 1; renderMain(); });

    // Init
    populateSelect(INFLUENCERS);
    renderMain();
  </script>
</body>
</html>
