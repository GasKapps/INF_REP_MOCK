<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Influencer Reputation — POC</title>

  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --shadow: 0 10px 25px rgba(2,6,23,.08); --radius: 16px;
      --blue:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1180px;margin:22px auto 60px;padding:0 16px}

    /* ---------- Top selector bar ---------- */
    .topBar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .picker{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="search"], select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      background:#fff;
      font-weight:900;
      color:var(--text);
      outline:none;
      min-width:260px;
      flex:1;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}

    /* ---------- Empty state ---------- */
    .empty{
      margin-top:16px;
      background:var(--card);
      border:1px dashed var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
    }
    .emptyTitle{margin:0 0 6px;font-size:18px;font-weight:1000}
    .emptyText{margin:0;color:var(--muted);font-weight:800;line-height:1.4}

    /* ---------- Main view ---------- */
    .header{
      margin-top:16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .left{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
      min-width:260px;
      flex:1;
    }
    .avatar{
      width:60px;height:60px;border-radius:999px;border:1px solid var(--line);
      background:linear-gradient(135deg,#c7d2fe,#e0e7ff);
      overflow:hidden;display:grid;place-items:center;font-weight:1000;color:#1e293b;
      cursor:pointer;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .title{margin:0;font-size:20px;font-weight:1000;line-height:1.1}
    .subRow{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    a{color:var(--blue);text-decoration:none;font-weight:1000}
    a:hover{text-decoration:underline}
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      font-size:11px;
      background:#f8fafc;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    /* Score meter */
    .scoreCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      min-width:240px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .scoreTop{display:flex;justify-content:space-between;align-items:flex-end;gap:10px}
    .scoreLabel{color:var(--muted);font-weight:1000;font-size:12px}
    .scoreValue{font-weight:1000;font-size:22px;line-height:1}
    .meter{
      width:100%;
      height:14px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .meterFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #16a34a 0%, #f59e0b 55%, #ef4444 100%);
      transition: width .2s ease;
    }
    .meterTicks{display:flex;justify-content:space-between;color:var(--muted);font-weight:900;font-size:11px}

    /* Cards */
    .grid{margin-top:16px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .cardTitle{margin:0;font-weight:1000;font-size:15px}
    .muted{color:var(--muted);font-weight:750;font-size:13px;line-height:1.45}

    /* Flags + deep dive */
    .flagsWrap{display:grid;grid-template-columns: 1.1fr .9fr;gap:14px}
    @media (max-width: 920px){ .flagsWrap{grid-template-columns:1fr} }
    .flagsList{display:flex;flex-wrap:wrap;gap:8px}
    .flagChip{
      border:1px solid var(--line);
      background:#f8fafc;
      border-radius:999px;
      padding:7px 10px;
      font-weight:1000;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .flagChip.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .flagChip .count{
      background:#fff;border:1px solid var(--line);
      padding:3px 7px;border-radius:999px;font-size:11px;color:var(--muted)
    }
    .flagChip.active .count{color:#0f172a}
    .deepDive{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      min-height:120px;
    }
    .deepDiveTitle{font-weight:1000;margin:0 0 10px;font-size:13px}
    .wordsGrid{display:flex;flex-wrap:wrap;gap:8px}
    .wordPill{
      font-size:12px;font-weight:1000;
      padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;
    }

    /* Flag hits bar (0..33) */
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .kpiTop{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap}
    .kpiTop .big{font-size:26px;font-weight:1000;line-height:1}
    .kpiTop .small{font-size:12px;color:var(--muted);font-weight:900;text-align:right}
    .bar{width:100%;height:12px;border-radius:999px;background:#f1f5f9;border:1px solid var(--line);overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ef4444,#f59e0b);transition:width .2s ease}
    .barLegend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;font-weight:900}

    /* Summary (match layout font + spacing per item) */
    .summaryList{display:flex;flex-direction:column;gap:12px}
    .summaryItem{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:12px;
    }
    .summaryItemTitle{
      font-weight:1000;
      font-size:13px;
      margin:0 0 6px;
    }
    .summaryItemText{
      margin:0;
      color:var(--text);
      font-weight:800;
      font-size:13px;
      line-height:1.5;
      white-space:pre-wrap;
    }

    /* Evidence */
    .filters{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .filterGroup{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .boxes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width: 980px){.boxes{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 620px){.boxes{grid-template-columns:1fr}}

    .box{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden;display:flex;flex-direction:column;min-height:220px}
    .boxImg{height:130px;background:linear-gradient(135deg,#e2e8f0,#f1f5f9)}
    .boxImg img{width:100%;height:100%;object-fit:cover}
    .boxBody{padding:12px;display:flex;flex-direction:column;gap:10px;flex:1}
    .boxTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .date{color:var(--muted);font-weight:900;font-size:11px}
    .titleLink{font-weight:1000;color:var(--blue);text-decoration:none;line-height:1.25;font-size:13px}
    .titleLink:hover{text-decoration:underline}
    .snippet{color:var(--text);font-weight:750;font-size:13px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;min-height:60px}
    .tagRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:auto}
    .miniTag{font-size:11px;font-weight:1000;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--text)}

    .pagination{margin-top:14px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap}
    .pageBtn{border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:10px;font-weight:1000;cursor:pointer;min-width:38px;text-align:center}
    .pageBtn.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .pageInfo{color:var(--muted);font-weight:900;font-size:12px;margin-top:10px;text-align:center}
  </style>
</head>

<body>
  <div class="container">

    <!-- TOP SELECTOR (always visible) -->
    <section class="topBar">
      <div class="picker">
        <input id="search" type="search" placeholder="Search by name or Instagram (e.g., Bad Bunny / @badbunnypr)"/>
        <select id="select">
          <option value="">Select an influencer…</option>
        </select>
        <button class="btn primary" id="openBtn">Open</button>
      </div>

      <!--
        ADD NEW INFLUENCER (markup only)
        1) Add influencer object into INFLUENCERS array in the script
        2) Add outputs into OUTPUTS map (key = influencer_id)
      -->
    </section>

    <!-- EMPTY STATE (shown until selection) -->
    <section class="empty" id="emptyState">
      <h2 class="emptyTitle">Select an influencer</h2>
      <p class="emptyText">
        Use the search box or the dropdown above. Once selected, the reputation view will appear here.
      </p>
    </section>

    <!-- MAIN VIEW (hidden until selection) -->
    <div id="mainView" style="display:none">
      <!-- Header -->
      <section class="header">
        <div class="left">
          <!-- Clicking avatar/name/handle goes to Instagram profile -->
          <a id="igHeaderLink" href="#" target="_blank" rel="noreferrer"
             style="display:flex;gap:14px;align-items:center;color:inherit;text-decoration:none">
            <div class="avatar" id="avatar">
              <img id="avatarImg" alt="avatar" src="" style="display:none"/>
              <span id="avatarFallback">IN</span>
            </div>
            <div>
              <h1 class="title" id="infName">—</h1>
              <div class="subRow">
                <span class="pill" id="igHandlePill">@—</span>
                <span class="pill">Influencer Reputation</span>
              </div>
            </div>
          </a>
        </div>

        <div class="scoreCard">
          <div class="scoreTop">
            <div>
              <div class="scoreLabel">Score (0–100)</div>
              <div class="scoreValue" id="scoreValue">0</div>
            </div>
          </div>
          <div class="meter"><div class="meterFill" id="meterFill"></div></div>
          <div class="meterTicks"><span>0</span><span>50</span><span>100</span></div>
        </div>
      </section>

      <div class="grid">

        <!-- (1) FLAGS + DEEP DIVE -->
        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Flags (tags) + Deep dive (keywords)</h3>
          </div>

          <div class="flagsWrap">
            <div>
              <div class="flagsList" id="flagsList"></div>
              <div class="muted" style="margin-top:10px">
                Click a flag to see the detected keywords.
              </div>
            </div>

            <div class="deepDive">
              <p class="deepDiveTitle" id="deepDiveTitle">Detected keywords</p>
              <div class="wordsGrid" id="wordsGrid"></div>
              <div class="muted" id="deepDiveHint" style="margin-top:10px;display:none">
                No keywords for this flag.
              </div>
            </div>
          </div>
        </section>

        <!-- (2) FLAG HITS (0..33) -->
        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Flag hits (0–33)</h3>
          </div>

          <div class="kpi">
            <div class="kpiTop">
              <div>
                <div style="font-weight:1000;font-size:13px">Total flags hit</div>
                <div class="big" id="flagHitsTotal">0</div>
              </div>
              <div class="small">
                Max: <span id="flagHitsMax">33</span><br/>
                % bar: <span id="flagHitsPct">0%</span>
              </div>
            </div>

            <div class="bar"><span id="flagHitsBar"></span></div>
            <div class="barLegend">
              <span>0</span><span>33</span>
            </div>

            <div class="muted">
              Total flags hit = number of <b>unique tags</b> detected for this influencer.
            </div>
          </div>
        </section>

        <!-- (3) SUMMARY -->
        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Influencer Executive Assessment</h3>
          </div>
          <div class="summaryList" id="summaryList"></div>
        </section>

        <!-- (4) EVIDENCE -->
        <section class="card">
          <div class="cardHeader">
            <h3 class="cardTitle">Evidence (Web / News)</h3>
          </div>

          <div class="filters">
            <div class="filterGroup">
              <select id="flagFilter">
                <option value="all">Filter by Flag (tag)</option>
              </select>
              <select id="sortFilter">
                <option value="recent">Sort: Most recent</option>
                <option value="quantity">Sort: Quantity (keywords per tag)</option>
              </select>
            </div>
          </div>

          <div class="boxes" id="boxes"></div>

          <div class="pagination" id="pagination"></div>
          <div class="pageInfo" id="pageInfo"></div>

          <div class="muted" style="margin-top:12px">
            News cards attempt to load a website preview image via a public service (best effort).
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // INFLUENCERS LIST
    // ============================================================================
    const INFLUENCERS = [
      { influencer_id: "bad_bunny", name: "Bad Bunny", instagram_handle: "badbunnypr" }
      // ADD NEXT INFLUENCER HERE (markup only)
      // { influencer_id: "cristiano", name: "Cristiano Ronaldo", instagram_handle: "cristiano" }
    ];

    // ============================================================================
    // OUTPUTS (manual paste)
    // ============================================================================
    const OUTPUTS = {
      bad_bunny: {
        score_0_100: 72,          // mock score

        flag_counting_rows: [
          { influencer: "Bad Bunny", words: "trump|bad|bunny|he|donald|political|maga|not|over|just", tag: "political" },
          { influencer: "Bad Bunny", words: "trump|bad|bunny|he|donald|political|maga|not|over|just", tag: "maga" },
          { influencer: "Bad Bunny", words: "protest|america|easter|egg|close|god|de|bless|country|teach", tag: "protest" }
        ],

        evidence_links_rows: [
          { influencer: "Bad Bunny", tag: "political", url: "https://www.nbcnews.com/pop-culture/pop-culture-news/jill-zarin-fired-real-housewives-revival-show-controver..." },
          { influencer: "Bad Bunny", tag: "political", url: "https://www.businessinsider.com/bad-bunny-super-bowl-message-immigation-diversity-ice-2026-2" },
          { influencer: "Bad Bunny", tag: "political", url: "https://www.businessinsider.com/bad-bunny-super-bowl-message-immigation-diversity-ice-2026-2" },
          { influencer: "Bad Bunny", tag: "political", url: "https://www.businessinsider.com/bad-bunny-super-bowl-message-immigation-diversity-ice-2026-2" },
          { influencer: "Bad Bunny", tag: "maga", url: "https://www.axios.com/2026/02/12/bad-bunny-halftime-streams-gop-backlash" },
          { influencer: "Bad Bunny", tag: "maga", url: "https://www.axios.com/2026/02/12/bad-bunny-halftime-streams-gop-backlash" },
          { influencer: "Bad Bunny", tag: "maga", url: "https://www.bbc.com/news/articles/c394g7nnzmzo" },
          { influencer: "Bad Bunny", tag: "maga", url: "https://www.bbc.com/news/articles/c394g7nnzmzo" }
        ],

        summary_text: `1. Profile Context
Bad Bunny is an internationally recognized music artist and public figure whose recent activities—including a high-profile Super Bowl halftime performance—have generated significant political and cultural attention. He is under review for potential influencer partnership.
2. Positive Reputation Signals
Bad Bunny is widely acknowledged for promoting unity, diversity, and inclusivity. He has received positive notice for his advocacy on Latino and Puerto Rican issues and is credited with using his platform to highlight underrepresented voices. Mainstream and international media frame him as a champion for cultural celebration and mobilization.
3. Risk & Sensitivity Factors
Associating with Bad Bunny carries clear reputational risk due to his documented engagement in political protest and public opposition to specific U.S. policies and political movements. He has faced direct criticism and backlash from conservative figures, and his actions have triggered controversy, including calls for investigation from partisan groups.
4. Net Brand Association Assessment
Partnering with Bad Bunny positions a brand as progressive, socially conscious, and supportive of diversity; however, it also introduces the potential for polarization and negative attention from audiences sensitive to political activism or critical of his stances.
5. Recommendation
Suitable with monitoring—Recommended for brands aligned with social impact and cultural diversity, contingent on ongoing review of the socio-political landscape and risk tolerance.`
      }
    };
#receita de bolo de milho verde
    // ============================================================================
    // DOM + STATE
    // ============================================================================
    const $ = (id) => document.getElementById(id);

    let selectedInfluencerId = "";
    let activeTag = null;
    let currentPage = 1;
    const pageSize = 6;

    // ============================================================================
    // Helpers
    // ============================================================================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str).replaceAll(" ","%20"); }

    function instagramUrl(handle){
      return `https://www.instagram.com/${encodeURIComponent(handle)}/`;
    }
    function instagramAvatarUrl(handle){
      return `https://unavatar.io/instagram/${encodeURIComponent(handle)}`;
    }

    function renderScore(score){
      const s = Math.max(0, Math.min(100, Number(score) || 0));
      $("scoreValue").textContent = String(s);
      $("meterFill").style.width = s + "%";
    }

    function buildTagKeywordsMap(rows){
      const map = new Map();
      (rows || []).forEach(r => {
        const tag = (r.tag || "").trim();
        const parts = String(r.words || "")
          .split("|")
          .map(w => w.trim())
          .filter(Boolean);

        if(!map.has(tag)) map.set(tag, new Set());
        const set = map.get(tag);
        parts.forEach(p => set.add(p));
      });
      return map;
    }

    function buildTagCounts(tagKeywordsMap){
      const counts = [];
      for(const [tag, set] of tagKeywordsMap.entries()){
        counts.push({ tag, count: set.size });
      }
      counts.sort((a,b) => b.count - a.count);
      return counts;
    }

    // Flag hits (0..33): number of unique tags found
    function computeFlagHits(tagCounts){
      return Math.min(33, (tagCounts || []).length);
    }

    function normalizeEvidence(rows){
      const seen = new Set();
      const out = [];
      (rows || []).forEach(r => {
        const tag = (r.tag || "").trim();
        const url = (r.url || "").trim();
        if(!tag || !url) return;

        const key = tag + "||" + url;
        if(seen.has(key)) return;
        seen.add(key);

        // Best-effort website preview image without API keys.
        // You can swap to another service later if needed.
        const previewImg = `https://image.thum.io/get/width/900/${encodeURIComponent(url)}`;

        out.push({
          evidence_id: "ev_" + String(out.length + 1).padStart(3,"0"),
          tag,
          url,
          title: url,            // INSERT NEXT: title if you start returning it
          snippet: "",           // INSERT NEXT: snippet if you start returning it
          publication_date: "",  // INSERT NEXT: date if you start returning it
          image_url: previewImg
        });
      });
      return out;
    }

    function renderDeepDive(tag, tagKeywordsMap){
      const set = tagKeywordsMap.get(tag) || new Set();
      $("deepDiveTitle").textContent = `Detected keywords — ${tag}`;
      $("wordsGrid").innerHTML = Array.from(set)
        .sort((a,b)=>a.localeCompare(b))
        .map(w => `<span class="wordPill">${escapeHtml(w)}</span>`)
        .join("");
      $("deepDiveHint").style.display = set.size ? "none" : "block";
    }

    // Summary parsing into items
    function parseSummaryToItems(text){
      const raw = String(text || "").trim();
      if(!raw) return [];

      const lines = raw.split("\n");
      const items = [];
      let current = null;

      function pushCurrent(){
        if(current && (current.title || current.body)){
          current.body = (current.body || "").trim();
          items.push(current);
        }
      }

      for(const line of lines){
        const m = line.match(/^(\d+)\.\s*(.+)$/);
        if(m){
          pushCurrent();
          current = { title: m[2].trim(), body: "" };
        }else{
          if(!current){
            current = { title: "Summary", body: "" };
          }
          current.body += (current.body ? "\n" : "") + line;
        }
      }
      pushCurrent();
      return items;
    }

    // Evidence: filter + sort + pagination
    function getFilteredEvidence(evidence){
      const tag = $("flagFilter").value;
      const sort = $("sortFilter").value;

      let list = [...evidence];
      if(tag !== "all") list = list.filter(ev => ev.tag === tag);

      if(sort === "quantity"){
        list.sort((a,b) => (b._tag_keyword_count||0) - (a._tag_keyword_count||0));
      }else{
        list.sort((a,b) => (b.publication_date||"").localeCompare(a.publication_date||""));
      }
      return list;
    }

    function buildPagination(totalPages){
      const btns = [];
      btns.push(`<div class="pageBtn" onclick="goPage(${Math.max(1, currentPage-1)})">«</div>`);

      const maxButtons = 7;
      let from = Math.max(1, currentPage - 2);
      let to = Math.min(totalPages, from + (maxButtons - 1));
      from = Math.max(1, to - (maxButtons - 1));

      for(let p=from;p<=to;p++){
        btns.push(`<div class="pageBtn ${p===currentPage?'active':''}" onclick="goPage(${p})">${p}</div>`);
      }
      btns.push(`<div class="pageBtn" onclick="goPage(${Math.min(totalPages, currentPage+1)})">»</div>`);
      return btns.join("");
    }
    window.goPage = function(p){
      currentPage = p;
      renderMain();
      window.scrollTo({ top: document.querySelector(".filters").getBoundingClientRect().top + window.scrollY - 140, behavior:"smooth" });
    };

    function renderEvidence(evidence){
      const list = getFilteredEvidence(evidence);
      const total = list.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage - 1) * pageSize;
      const slice = list.slice(start, start + pageSize);

      $("boxes").innerHTML = slice.map(ev => {
        const imgHtml = ev.image_url
          ? `<div class="boxImg">
               <img alt="preview" src="${escapeAttr(ev.image_url)}"
                    onerror="this.remove(); this.parentElement.style.display='none'"/>
             </div>`
          : ``;

        return `
          <div class="box">
            ${imgHtml}
            <div class="boxBody">
              <div class="boxTop">
                <span class="pill">WEB/NEWS</span>
                <span class="date">${escapeHtml(ev.publication_date || "")}</span>
              </div>
              <a class="titleLink" href="${escapeAttr(ev.url)}" target="_blank" rel="noreferrer">
                ${escapeHtml(ev.title || ev.url)}
              </a>
              <div class="snippet">${escapeHtml(ev.snippet || "")}</div>
              <div class="tagRow">
                <span class="miniTag">tag: ${escapeHtml(ev.tag)}</span>
                <span class="miniTag">keywords: ${escapeHtml(ev._tag_keyword_count || 0)}</span>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">No evidence for this filter.</div>`;

      $("pagination").innerHTML = buildPagination(totalPages);
      const showingFrom = total === 0 ? 0 : start + 1;
      const showingTo = Math.min(total, start + slice.length);
      $("pageInfo").textContent = `${showingFrom} - ${showingTo} of ${total} (page ${currentPage}/${totalPages})`;
    }

    // ============================================================================
    // Main render after selection
    // ============================================================================
    function renderMain(){
      if(!selectedInfluencerId){
        $("mainView").style.display = "none";
        $("emptyState").style.display = "block";
        return;
      }

      const inf = INFLUENCERS.find(x => x.influencer_id === selectedInfluencerId);
      const out = OUTPUTS[selectedInfluencerId];

      $("emptyState").style.display = "none";
      $("mainView").style.display = "block";

      // Instagram header link (avatar + name + handle)
      const ig = instagramUrl(inf.instagram_handle);
      $("igHeaderLink").href = ig;
      $("igHandlePill").textContent = `@${inf.instagram_handle}`;

      // Header
      $("infName").textContent = inf?.name || "—";
      $("avatarFallback").textContent = (inf?.name || "IN")
        .split(" ").slice(0,2).map(x=>x[0]).join("").toUpperCase();

      const img = $("avatarImg");
      img.src = instagramAvatarUrl(inf.instagram_handle);
      img.onload = () => { img.style.display="block"; $("avatarFallback").style.display="none"; };
      img.onerror = () => { img.style.display="none"; $("avatarFallback").style.display="block"; };

      renderScore(out?.score_0_100 ?? 0);

      // Compute tags/keywords
      const tagKeywordsMap = buildTagKeywordsMap(out?.flag_counting_rows || []);
      const tagCounts = buildTagCounts(tagKeywordsMap);

      if(!activeTag){
        activeTag = tagCounts[0]?.tag || null;
      }

      // Flags list
      $("flagsList").innerHTML = tagCounts.map(x => `
        <span class="flagChip ${x.tag===activeTag?'active':''}" data-tag="${escapeAttr(x.tag)}">
          ${escapeHtml(x.tag)}
          <span class="count">${escapeHtml(x.count)}</span>
        </span>
      `).join("") || `<span class="muted">No flags.</span>`;

      document.querySelectorAll(".flagChip").forEach(el => {
        el.addEventListener("click", () => {
          activeTag = el.getAttribute("data-tag");
          renderMain();
        });
      });

      // Deep dive
      if(activeTag) renderDeepDive(activeTag, tagKeywordsMap);

      // Flag hits (0..33)
      const hits = computeFlagHits(tagCounts);
      const pct = Math.round((hits / 33) * 100);
      $("flagHitsTotal").textContent = String(hits);
      $("flagHitsMax").textContent = "33";
      $("flagHitsPct").textContent = pct + "%";
      $("flagHitsBar").style.width = pct + "%";

      // Summary -> items with spacing + same font
      const items = parseSummaryToItems(out?.summary_text || "");
      $("summaryList").innerHTML = items.map(it => `
        <div class="summaryItem">
          <p class="summaryItemTitle">${escapeHtml(it.title)}</p>
          <p class="summaryItemText">${escapeHtml(it.body)}</p>
        </div>
      `).join("") || `<div class="muted">—</div>`;

      // Evidence
      const evidence = normalizeEvidence(out?.evidence_links_rows || []);
      evidence.forEach(ev => {
        const set = tagKeywordsMap.get(ev.tag) || new Set();
        ev._tag_keyword_count = set.size;
      });

      // Build tag filter options
      const tags = tagCounts.map(x => x.tag);
      const currentFilter = $("flagFilter").value || "all";
      $("flagFilter").innerHTML =
        `<option value="all">Filter by Flag (tag)</option>` +
        tags.map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join("");

      if(tags.includes(currentFilter)) $("flagFilter").value = currentFilter;
      else $("flagFilter").value = "all";

      renderEvidence(evidence);
    }

    // ============================================================================
    // Selector behavior (search filters select list)
    // ============================================================================
    function populateSelect(options){
      $("select").innerHTML = `<option value="">Select an influencer…</option>` +
        options.map(i => `<option value="${escapeAttr(i.influencer_id)}">${escapeHtml(i.name)} (@${escapeHtml(i.instagram_handle)})</option>`).join("");
    }

    function applySearch(){
      const q = $("search").value.trim().toLowerCase();
      const filtered = INFLUENCERS.filter(i =>
        !q ||
        i.name.toLowerCase().includes(q) ||
        i.instagram_handle.toLowerCase().includes(q) ||
        ("@" + i.instagram_handle).toLowerCase().includes(q)
      );
      populateSelect(filtered);
    }

    $("search").addEventListener("input", () => {
      const current = $("select").value;
      applySearch();
      $("select").value = current;
    });

    function openSelected(){
      selectedInfluencerId = $("select").value || "";
      activeTag = null;
      currentPage = 1;
      renderMain();
    }

    $("openBtn").addEventListener("click", () => {
      if(!$("select").value){
        selectedInfluencerId = "";
        renderMain();
        return;
      }
      openSelected();
    });

    $("flagFilter").addEventListener("change", () => { currentPage = 1; renderMain(); });
    $("sortFilter").addEventListener("change", () => { currentPage = 1; renderMain(); });

    // Init
    populateSelect(INFLUENCERS);
    renderMain();
  </script>
</body>
</html>
